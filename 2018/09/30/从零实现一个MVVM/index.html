<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="从零实现一个MVVM"><meta name="keywords" content="Wheels"><meta name="author" content="Day Break,undefined"><meta name="copyright" content="Day Break"><title>从零实现一个MVVM | Jeremy's blog</title><link rel="shortcut icon" href="/my-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.5.6"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css?version=1.5.6"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#介绍"><span class="toc-number">1.</span> <span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#数据劫持"><span class="toc-number">2.</span> <span class="toc-text">数据劫持</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#编译过程"><span class="toc-number">3.</span> <span class="toc-text">编译过程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#扩展-Proxy"><span class="toc-number">4.</span> <span class="toc-text">扩展: Proxy</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="http://ww1.sinaimg.cn/large/e4336439gy1ftum80p9mtj20rs0rs0we.jpg"></div><div class="author-info__name text-center">Day Break</div><div class="author-info__description text-center">仰望星空，脚踏实地，因为相信，所以看见</div><div class="follow-button"><a href="https://github.com/fxbabys" target="_blank">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">31</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">15</span></a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(http://ww1.sinaimg.cn/large/e4336439gy1ftulr1hkycj21xg12w1ky.jpg);"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Jeremy's blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> Search</span></a><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a></span></div><div id="post-info"><div id="post-title">从零实现一个MVVM</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2018-10-01</time><span class="post-meta__separator">|</span><i class="fa fa-comment-o post-meta__icon" aria-hidden="true"></i><a href="/2018/09/30/从零实现一个MVVM/#disqus_thread"><span class="disqus-comment-count" data-disqus-identifier="2018/09/30/从零实现一个MVVM/"></span></a><div class="post-meta-wordcount"><span>Word count: </span><span class="word-count">1,928</span><span class="post-meta__separator">|</span><span>Reading time: 9 min</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><p>MVVM 由以下三个内容组成:</p>
<ul>
<li>Model: 数据模型</li>
<li>View: 界面</li>
<li>ViewModal: 沟通 View 和 Model</li>
</ul>
<p>MVVM 的思想是数据驱动视图，相比于 jQuery 操作 DOM 的时代，数据逻辑与页面实现了解耦，数据改变&lt;=&gt;UI改变，数据与业务的处理都放在 ViewModel 中并且可以复用</p>
<p>MVVM 中最核心的就是数据双向绑定，如 Angluar 的脏数据检测，Vue 中的数据劫持</p>
<p>接下来就详细解析实现基于数据劫持的双向绑定，功能上参考 v-model 还会完善一下编译的过程</p>
<h3 id="数据劫持"><a href="#数据劫持" class="headerlink" title="数据劫持"></a>数据劫持</h3><p>首先是 DOM 元素以及类的实例化使用: </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span>             </span><br><span class="line">	<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">v-model</span>=<span class="string">"message"</span>&gt;</span></span><br><span class="line">	&#123;&#123;message&#125;&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> vm = <span class="keyword">new</span> MVVM(&#123;</span><br><span class="line">    el: <span class="string">'#app'</span>,</span><br><span class="line">    data: &#123;</span><br><span class="line">        message: <span class="string">'Hello Jeremy!'</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>这里实例化了一个 MVVM 类，我们来实现它的初始结构:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MVVM</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span> (options) &#123;</span><br><span class="line">        <span class="keyword">this</span>.$el = options.el</span><br><span class="line">        <span class="keyword">this</span>.$data = options.data</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.$el) &#123;</span><br><span class="line">            <span class="keyword">new</span> Observer(<span class="keyword">this</span>.$el, <span class="keyword">this</span>) <span class="comment">// 数据劫持</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来就是 Observer 类:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Observer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span> (data) &#123;</span><br><span class="line">        <span class="keyword">this</span>.observe(data) <span class="comment">// 劫持函数</span></span><br><span class="line">    &#125;</span><br><span class="line">    observe (data) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!data || <span class="keyword">typeof</span> data !== <span class="string">'object'</span>) <span class="keyword">return</span></span><br><span class="line">        <span class="built_in">Object</span>.keys(data).forEach(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.defineReactive(data, key, datat[key])</span><br><span class="line">            <span class="keyword">this</span>.observe(data[key]) <span class="comment">// 递归劫持 -&gt;　针对嵌套对象</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    defineReactive (data, key, value) &#123;</span><br><span class="line">        <span class="keyword">const</span> _this = <span class="keyword">this</span></span><br><span class="line">        <span class="keyword">const</span> dep = <span class="keyword">new</span> Dep()　<span class="comment">// Observer 与 Watcher 解耦</span></span><br><span class="line">        <span class="built_in">Object</span>.defineProperty(data, key, &#123;  <span class="comment">// 双向绑定关键</span></span><br><span class="line">            enumerable: <span class="literal">true</span>,</span><br><span class="line">            configurable: <span class="literal">true</span>,</span><br><span class="line">            get () &#123;</span><br><span class="line">                Dep.target &amp;&amp; dep.subscribe(Dep.target) <span class="comment">// 订阅 Watcher 对象</span></span><br><span class="line">                <span class="keyword">return</span> value</span><br><span class="line">            &#125;,</span><br><span class="line">            set () &#123;</span><br><span class="line">                <span class="keyword">if</span> (newValue !== value) &#123;</span><br><span class="line">                    value = newValue</span><br><span class="line">                    _this.observe(newValue) <span class="comment">// 赋值也劫持</span></span><br><span class="line">                    dep.notify()</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Dep 类:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dep</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span> () &#123;</span><br><span class="line">        <span class="keyword">this</span>.subs = []</span><br><span class="line">    &#125;</span><br><span class="line">    subscribe (watcher) &#123;</span><br><span class="line">        <span class="keyword">this</span>.subs.push(watcher)</span><br><span class="line">    &#125;</span><br><span class="line">    notify () &#123;</span><br><span class="line">        <span class="keyword">this</span>.subs.forEach(<span class="function"><span class="params">watcher</span> =&gt;</span> watcher.update())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来就是 Watcher 类:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Watcher</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span> (vm, expr, cb) &#123;</span><br><span class="line">        <span class="keyword">this</span>.vm = vm</span><br><span class="line">        <span class="keyword">this</span>.expr = expr</span><br><span class="line">        <span class="keyword">this</span>.cb = cb</span><br><span class="line">        <span class="keyword">this</span>.value = <span class="keyword">this</span>.get() <span class="comment">// 初始化时保存当前值</span></span><br><span class="line">    &#125;</span><br><span class="line">    getVal (vm, expr) &#123;  <span class="comment">// 兼容嵌套对象的取值</span></span><br><span class="line">        <span class="keyword">const</span> attrs = expr.split(<span class="string">'.'</span>)</span><br><span class="line">        <span class="keyword">return</span> attrs.reduce(<span class="function">(<span class="params">prev, next</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> prev[next]</span><br><span class="line">        &#125;, vm.$data)</span><br><span class="line">    &#125;</span><br><span class="line">    get () &#123;</span><br><span class="line">        Dep.target = <span class="keyword">this</span>  <span class="comment">// 将 target 指向自己</span></span><br><span class="line">        <span class="keyword">const</span> value = <span class="keyword">this</span>.getVal(<span class="keyword">this</span>.vm, <span class="keyword">this</span>.expr)　<span class="comment">// 触发 getter 监听</span></span><br><span class="line">        Dep.target = <span class="literal">null</span>  <span class="comment">// 置空</span></span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line">    &#125;</span><br><span class="line">    update () &#123;</span><br><span class="line">        <span class="keyword">const</span> newValue = <span class="keyword">this</span>.getVal(<span class="keyword">this</span>.vm, <span class="keyword">this</span>.expr)</span><br><span class="line">        <span class="keyword">const</span> oldValue = <span class="keyword">this</span>.value</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (newValue !== oldValue) &#123;</span><br><span class="line">            <span class="keyword">this</span>.cb(newValue) <span class="comment">// 对应 watcher 的更新回调</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上三个类就是关于数据劫持的核心代码，new MVVM 时将 data 传入 observe 类中进行劫持，通过 <code>Object.defineProperty</code> 属性设置 getter 与 setter，在 new Watcher 类时构造函数调用 get 方法，触发 getter 监听并将对应 watcher 实例保存在 dep 对象数组中，修改数据值时 触发 setter 调用 notify 方法，遍历所有 watcher 实例，值修改了的实例就更新</p>
<p>那么 new Watcher 在哪里会调用呢？．．．</p>
<h3 id="编译过程"><a href="#编译过程" class="headerlink" title="编译过程"></a>编译过程</h3><p>数据劫持完之后便是对节点的编译:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MVVM</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span> (options) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.$el) &#123;</span><br><span class="line">            <span class="keyword">new</span> Observer(<span class="keyword">this</span>.$data) <span class="comment">// 数据劫持</span></span><br><span class="line">            <span class="keyword">new</span> Compile(<span class="keyword">this</span>.$el, <span class="keyword">this</span>) <span class="comment">// 节点编译</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以最后我们要来实现 Compile 类:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Compile</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span> (el, vm) &#123;</span><br><span class="line">        <span class="keyword">this</span>.el = isElementNode(el) ? el : <span class="built_in">document</span>.querySelector(el)</span><br><span class="line">        <span class="keyword">this</span>.vm = vm</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.el) &#123;</span><br><span class="line">            <span class="keyword">const</span> fragment = <span class="keyword">this</span>.nodeToFragment(<span class="keyword">this</span>.el) <span class="comment">// 将真实DOM移入内存中</span></span><br><span class="line">            <span class="keyword">this</span>.compile(fragment)　　　　　　　　　　　　　　<span class="comment">// 编译 v-model 和 &#123;&#123;&#125;&#125; 节点</span></span><br><span class="line">            <span class="keyword">this</span>.el.appendChild(fragment)                <span class="comment">// 重新塞回页面中</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    isElementNode (el) &#123;</span><br><span class="line">        <span class="keyword">return</span> el.nodeType === <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">    isDirective (attr) &#123;</span><br><span class="line">        <span class="keyword">return</span> attr.inculdes(<span class="string">'v-'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    nodeToFragment (el) &#123;</span><br><span class="line">        <span class="keyword">const</span> fragment = <span class="built_in">document</span>.createDocumentFragment()</span><br><span class="line">        <span class="keyword">let</span> firstChild</span><br><span class="line">        <span class="keyword">while</span> (firstChild = el.firstChild) &#123;</span><br><span class="line">            fragment.appendChild(firstChild)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> fragment</span><br><span class="line">    &#125;</span><br><span class="line">    compile (fragment) &#123;</span><br><span class="line">        <span class="keyword">const</span> nodes = fragment.childNodes</span><br><span class="line">        <span class="built_in">Array</span>.from(nodes).forEach(<span class="function"><span class="params">node</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.isElementNode(node)) &#123; <span class="comment">// 判断元素节点与文本节点</span></span><br><span class="line">                <span class="keyword">this</span>.compileElement(node)</span><br><span class="line">                <span class="keyword">this</span>.compile(node) <span class="comment">// 元素节点需要递归判断</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">this</span>.compileText(node)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    compileElement (node) &#123;</span><br><span class="line">        <span class="keyword">const</span> attrs = node.attributes</span><br><span class="line">        <span class="built_in">Array</span>.from(attrs).forEach(<span class="function"><span class="params">attr</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.isDirective(attr)) &#123;</span><br><span class="line">                <span class="keyword">const</span> [, type] = attr.split(<span class="string">'-'</span>)  <span class="comment">// 现在这里 type 就是 model</span></span><br><span class="line">                CompileUtil[type](node, <span class="keyword">this</span>.vm, attr.value)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    compileText (node) &#123;</span><br><span class="line">        <span class="keyword">const</span> expr = node.textContent</span><br><span class="line">        <span class="keyword">const</span> reg = <span class="regexp">/\&#123;\&#123;([^&#125;]+)\&#125;\&#125;/g</span>  <span class="comment">// &#123;&#123; message &#125;&#125;</span></span><br><span class="line">        <span class="keyword">if</span> (reg.test(expr)) &#123;</span><br><span class="line">            CompileUtil[<span class="string">'text'</span>](node, <span class="keyword">this</span>.vm, expr)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到对于元素或者文本节点的具体处理我们封装了一个 CompileUtil 对象，来实现它: </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">CompileUtil = &#123;</span><br><span class="line">    text (node, vm, expr) &#123;</span><br><span class="line">        <span class="keyword">const</span> updateFn = <span class="keyword">this</span>.updater[<span class="string">'textUpdater'</span>]</span><br><span class="line">        expr.replace(<span class="regexp">/\&#123;\&#123;([^&#125;]+)\&#125;\&#125;/g</span>, (...arguments) =&gt; &#123;</span><br><span class="line">            <span class="comment">// Boom~, new Watcher 在这</span></span><br><span class="line">            <span class="keyword">new</span> Watcher(vm, <span class="built_in">arguments</span>[<span class="number">1</span>].trim(), newValue =&gt; &#123;</span><br><span class="line">                updateFn &amp;&amp; updateFn(node, <span class="keyword">this</span>.getTextVal(vm, expr)) <span class="comment">// 数据变化时文本节点需要重新获取依赖属性更新文本内容</span></span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">        updateFn &amp;&amp; updateFn(node, thie.getTextVal(vm, expr)) <span class="comment">// 初始编译</span></span><br><span class="line">    &#125;,</span><br><span class="line">    model (node, vm, expr) &#123;</span><br><span class="line">        <span class="keyword">const</span> udpateFn = <span class="keyword">this</span>.updater[<span class="string">'modelUpdater'</span>]</span><br><span class="line">        <span class="keyword">new</span> Watcher(vm, expr, newValue =&gt; &#123;</span><br><span class="line">            updateFn &amp;&amp; updateFn(node, newValue)</span><br><span class="line">        &#125;)</span><br><span class="line">        node.addEventListener(<span class="string">'input'</span>, e =&gt; &#123; <span class="comment">// 监听 input 事件</span></span><br><span class="line">            <span class="keyword">const</span> newValue = e.target.value</span><br><span class="line">            <span class="keyword">this</span>.setVal(vm, expr, newValue)</span><br><span class="line">        &#125;)</span><br><span class="line">        updateFn &amp;&amp; updateFn(node, <span class="keyword">this</span>.getVal(vm, expr))</span><br><span class="line">    &#125;,</span><br><span class="line">    updater: &#123;</span><br><span class="line">        textUpdater (node, value) &#123;</span><br><span class="line">            node.textContent = value <span class="comment">// 文本节点赋值</span></span><br><span class="line">        &#125;,</span><br><span class="line">        modelUpdater (node, value) &#123;</span><br><span class="line">            node.value = value <span class="comment">// 元素节点赋值</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    getVal (vm, expr) &#123; <span class="comment">// 对嵌套对象值的获取</span></span><br><span class="line">        <span class="keyword">const</span> attrs = expr.split(<span class="string">'.'</span>)</span><br><span class="line">        <span class="keyword">return</span> attrs.reduce(<span class="function">(<span class="params">prev, next</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> prev[next]</span><br><span class="line">        &#125;, vm.$data)</span><br><span class="line">    &#125;,</span><br><span class="line">    getTextVal (vm, expr) &#123;</span><br><span class="line">        <span class="keyword">return</span> expr.replace(<span class="regexp">/\&#123;\&#123;([^&#125;]+)\&#125;\&#125;/g</span>, (...arguemnts) =&gt; &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.getVal(vm, <span class="built_in">arguments</span>[<span class="number">1</span>].trim())</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    setVal (vm, expr, value) &#123;</span><br><span class="line">        <span class="keyword">const</span> attrs = expr.split(<span class="string">'.'</span>)</span><br><span class="line">        <span class="keyword">return</span> attrs.reduce(<span class="function">(<span class="params">prev, next, currentIndex</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (currentIndex === attrs.length - <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> prev[next] = value <span class="comment">// 对最后的非对象赋值</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> prev[next]</span><br><span class="line">        &#125;, vm.$data)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编译时首先将真实DOM节点放入内存中编译 v-model 与 {　{ }　} 两类节点，对于元素节点与文本节点分别以不同的回调函数实例化 Watcher 类，并且完善了对于多层嵌套对象的处理，至此，在编译的过程了关联了对应的 watcher 实例，重新塞回页面后更改属性值便会触发 setter 进而更新页面</p>
<h3 id="扩展-Proxy"><a href="#扩展-Proxy" class="headerlink" title="扩展: Proxy"></a>扩展: Proxy</h3><p><code>Object.defineProperty</code> 目前实现的双向绑定的缺陷:</p>
<ul>
<li>只能对属性进行数据劫持，所以需要深度遍历整个对象</li>
<li>不能监听到数组数据的变化</li>
</ul>
<p>而对于 Vue 来说，它本身做了一定的 hack 可以检测到数组数据的变化:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/core/observer/array.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; def &#125; <span class="keyword">from</span> <span class="string">'../util/index'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> arrayProto = <span class="built_in">Array</span>.prototype</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> arrayMethods = <span class="built_in">Object</span>.create(arrayProto)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> methodsToPatch = [</span><br><span class="line">    <span class="string">'push'</span>,</span><br><span class="line">    <span class="string">'pop'</span>,</span><br><span class="line">    <span class="string">'shift'</span>,</span><br><span class="line">    <span class="string">'unshift'</span>,</span><br><span class="line">    <span class="string">'splice'</span>,</span><br><span class="line">    <span class="string">'sort'</span>,</span><br><span class="line">    <span class="string">'reverse'</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 拦截变异方法并且触发事件</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">methodsToPatch.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">method</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 获得原生函数</span></span><br><span class="line">    <span class="keyword">const</span> original = arrayProto[method]</span><br><span class="line">    def(arrayMethods, method, <span class="function"><span class="keyword">function</span> <span class="title">mutator</span> (<span class="params">...args</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> result = original.call(<span class="keyword">this</span>, args) <span class="comment">// 先调用原生函数</span></span><br><span class="line">        <span class="keyword">const</span> ob = <span class="keyword">this</span>.__ob__</span><br><span class="line">        <span class="keyword">let</span> inserted</span><br><span class="line">        <span class="keyword">switch</span> (method) &#123;  <span class="comment">//　获取到插入的值</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">'push'</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'unshift'</span>:</span><br><span class="line">                inserted = args</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">'splice'</span>:</span><br><span class="line">            	inserted = args.splice(<span class="number">2</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (inserted) ob.observeArray(inserted)</span><br><span class="line">        <span class="comment">// 触发更新</span></span><br><span class="line">        ob.dep.notify()</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>通过对原生函数的 hack， Vue 可以检测到数据数组的变化，但是还是有局限性：</p>
<ul>
<li>不能检测到以下变动的数组<ul>
<li>利用索引直接设置一个项时，如：<code>vm.items[indexOfItem] = newValue</code></li>
<li>修改数组的长度时，如：<code>vm.items.length = newLength</code></li>
</ul>
</li>
</ul>
<p>什么是<a href="http://es6.ruanyifeng.com/#docs/proxy" target="_blank" rel="noopener">Proxy</a>?  原生支持监听数组变化并且可以直接对整个对象进行拦截</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> onWatch = <span class="function">(<span class="params">obj, setBind, getLogger</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> handler = &#123;</span><br><span class="line">        get(target, property, receiver) &#123;</span><br><span class="line">        	getLogger(target, property)</span><br><span class="line">        	<span class="keyword">return</span> <span class="built_in">Reflect</span>.get(target, property, receiver)</span><br><span class="line">    	&#125;,</span><br><span class="line">        set(target, property, value) &#123;</span><br><span class="line">            setBind(value)</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">Reflect</span>.set(target, property, value)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Proxy</span>(obj, handler)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> obj = &#123;</span><br><span class="line">    a: &#123;</span><br><span class="line">        b: <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> arr = [<span class="number">0</span>, <span class="number">1</span>]</span><br><span class="line"><span class="keyword">let</span> value</span><br><span class="line"><span class="keyword">const</span> pObj = onWatch(obj, v =&gt; &#123; value = v &#125;, (target, property) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`Get '<span class="subst">$&#123;property&#125;</span>' = <span class="subst">$&#123;target[property]&#125;</span>`</span>)</span><br><span class="line">&#125;)</span><br><span class="line">pObj.a.b = <span class="number">2</span></span><br><span class="line"><span class="keyword">const</span> pArr = onWatch(obj, v =&gt; &#123; value = v &#125;, (target, property) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`Get '<span class="subst">$&#123;property&#125;</span>' = <span class="subst">$&#123;target[property]&#125;</span>`</span>)</span><br><span class="line">&#125;)</span><br><span class="line">pArr[<span class="number">0</span>] = <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>如今 Proxy 已经基本被各大浏览器都支持，Vue3.0 的计划中就有基于Proxy实现全语言覆盖的变动侦测</p>
<p>参考链接:</p>
<ol>
<li><a href="https://ustbhuangyi.github.io/vue-analysis/reactive/questions.html" target="_blank" rel="noopener">Vue.js技术揭秘：检测变化的注意事项</a></li>
<li><a href="https://yuchengkai.cn/docs/zh/frontend/framework.html#proxy-%E4%B8%8E-object-defineproperty-%E5%AF%B9%E6%AF%94" target="_blank" rel="noopener">面试图谱：Proxy 与 Object.defineProperty 对比</a></li>
</ol>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Day Break</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://jeremygo.cn/2018/09/30/从零实现一个MVVM/">https://jeremygo.cn/2018/09/30/从零实现一个MVVM/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Wheels/">Wheels</a></div><div class="addthis_inline_share_toolbox pull-right"></div><script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5bb0153caccded2f" async></script><nav id="pagination"><div class="prev-post pull-left"><a href="/2018/10/07/每周精进-10-7/"><i class="fa fa-chevron-left">  </i><span>每周精进(10.7)</span></a></div><div class="next-post pull-right"><a href="/2018/09/29/每周精进-9-30/"><span>每周精进(9.30)</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="disqus_thread"></div><script>var unused = null;
var disqus_config = function () {
  this.page.url = 'https://jeremygo.cn/2018/09/30/从零实现一个MVVM/';
  this.page.identifier = '2018/09/30/从零实现一个MVVM/';
  this.page.title = '从零实现一个MVVM';
}
var d = document, s = d.createElement('script');
s.src = "https://" + 'jeremygo' +".disqus.com/embed.js";
s.setAttribute('data-timestamp', '' + +new Date());
(d.head || d.body).appendChild(s);</script><script id="dsq-count-src" src="https://jeremygo.disqus.com/count.js" async></script></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2017 - 2018 By Day Break</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.5.6"></script><script src="/js/fancybox.js?version=1.5.6"></script><script src="/js/sidebar.js?version=1.5.6"></script><script src="/js/copy.js?version=1.5.6"></script><script src="/js/fireworks.js?version=1.5.6"></script><script src="/js/transition.js?version=1.5.6"></script><script src="/js/scroll.js?version=1.5.6"></script><script src="/js/head.js?version=1.5.6"></script><script src="/js/search/local-search.js"></script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>